# Overview
---
This directory includes scripts and descriptions for running example Auths and entities.
The scripts are used to clean and generate credentials (certificates and keystores) for example Auths and entities.

**Important: The examples described here are just for demonstration, not for actual deployment. Each Auth and each entity MUST be deployed separately in actual settings, although everything is assumed to be in the same machine in the following examples.**

# Example details
---
![Image of Example Auths and entities](https://raw.githubusercontent.com/iotauth/iotauth/master/examples/figures/example_description.png)

The figure above illustrates the example with two Auths (*Auth101* and *Auth102*) and their example entities. *Auth101* (Auth with ID 101) is an authorization entity for network 1 (net1), and it has two registered entities, namely, *net1.server* and *net1.client*. *Auth102* (Auth with ID 102) is for network 2 (net2) with two registered entities, *net2.server* and *net2.client*.

Each Auth has its own public keys (or certificates) and keystores in the directory, *auth/credentials/*. Each entity has its own public key and private key in the directory, *entity/credentials/*. These credentials (public keys and private keys) can be generated by running a script (generateExampleAuthsEntities.sh) included in this directory. 

Each Auth stores public keys of its registered entities, and each entity stores its Auth's public key. The script (generateExampleAuthsEntities.sh) also exchanges the public keys between each Auth and its entities by copying them. The Auths store the public keys of their entities as part of their databases, specifically, in the directories, *auth/databases/auth101/certs/* and *auth/databases/auth102/certs/*. For entities, the public keys of Auths are stored in the directory, *entity/auth_certs/*.

Database tables for storing authorization information should be initialized for each eaxample Auth. The script (generateExampleAuthsEntities.sh) does this database initialization as the last step of the script. The initialized databases are created for *Auth101* and *Auth102* in the directorories, *auth/databases/auth101* and *auth/databases/auth101*, respectively, with the file name *auth.db*. Currently, we use SQLite for Auth databases.

# Script details
---
### generateExampleAuthsEntities.sh

This script generates credentials for example Auths and example entities. And it copies certificates (public keys) of entities to Auths' databases, and copies certificates (public keys) of Auths to entities' local directories. This script uses following helper scripts.

- **auth/credentials/generateCACredentials.sh**: This helper script generates credentials (public key, private key) for certificate authority which signs certificates of example Auths and entities.

- **auth/credentials/generateExampleAuthCredentials.sh**: This helper script generates credentials for example Auths.

- **entity/credentials/generateExampleEntityCredentials.sh**: This helper script generates credentials for example entities.

- **auth/example-auth-db-generator/generateExampleAuthDB.sh**: This helper script generates databases for Example Auths

### cleanExampleAuthsEntities.sh

This scripts deletes all credentials of example Auths and entities, and deletes databases for example Auths.

# How to run examples
---

For this section, we use *$ROOT* for the root directory of this repository.

### To generate credentials for example Auths and entities, and to create example Auth databases

1. Change directory to *$ROOT/examples*.

2. Run the script *generateExampleAuthsEntities.sh*, by entering './generateExampleAuthsEntities.sh'. To run the script OpenSSL and Maven command line tools should be installed a priory. If you're using Mac OS X, they can be installed using [Homebrew](http://brew.sh/), by entering 'brew install openssl' and 'brew install maven'.

3. If the script (generateExampleAuthsEntities.sh) finishes without an error, the credentials for Auths and entities and databases for Auths should be created. Here are instructions for running example Auths and entities.

4. If there is any error or you want to start with a clean copy, you can delete all generated credentials and Auth databases by running the script *cleanExampleAuthsEntities.sh*, with the command './cleanExampleAuthsEntities.sh'.

### To run example Auths (in command line)

1. Change directories to *$ROOT/auth/auth-server/*.

2. Run 'mvn clean install' to build an executable jar file. (Maven command line tools should be installed a priori. If it is not installed and you are using Mac OS X, then you can install it easily using [Homebrew](http://brew.sh/), by entering 'brew install maven'.)

3. Run the jar file with the properties file for Auth101, with 'java -jar target/auth-server-jar-with-dependencies.jar -p ../properties/exampleAuth101.properties'. Information of Auth101 will appear on the screen. If you see 'Enter command (e.g., show re/cp/ta/sk, clean sk):' at the end of the screen, that means Auth101 is successfully running.

4. For the example with multiple Auths, Run Auth102 with 'java -jar target/auth-server-jar-with-dependencies.jar -p ../properties/exampleAuth102.properties', in a separate terminal.

5. After running example Auths, you can view database table contents of each Auth, using the show commands (show re, show cp, show ta, show sk).

### To run example Auths using IntelliJ IDEA for development.

See README.md under *auth/*.

### To run example entities written in Node.js

1. Change directories to *$ROOT/entity/node/example_entities/*.

2. Run 'node client.js configs/net1/client.config', to execute net1.client.

3. Run 'node server.js configs/net1/server.config' in a separate terminal, to execute net1.server.

4. Within net1.client, enter 'skReq' to send a session key request to Auth101.

5. Within net1.client, enter 'initComm net1.server' to start a secure communication with net1.server.

6. Within net1.client, enter 'send blah blah' to send a (encrypted) message to net1.server, do the same within net1.server to send a (encrypted) message to net1.client.

7. Within net1.client, enter 'finComm' to end the secure communication with net1.server.

8. For entities in net2 registered with Auth102, run 'node client.js configs/net2/client.config', to execute net2.client, and run 'node server.js configs/net2/server.config', to execute net2.server.

9. Do the same within net2.client and net2.server as in the steps 4-7.

### To run example entities written in Cape Code

1. [Install Ptolemy II](https://chess.eecs.berkeley.edu/ptexternal/) and run the [Cape Code Swarmlet host](https://www.terraswarm.org/accessors/hosts/ptolemy/index.html).

2. $PTII is for the root directory of the Ptolemy II repository. Open two Cape Code models, $PTII/ptolemy/actor/lib/jjs/modules/iotAuth/demo/SecureCommClient/SecureCommClient.xml and $PTII/ptolemy/actor/lib/jjs/modules/iotAuth/demo/SecureCommServer/SecureCommServer.xml.

3. Change the value of the parameter 'IOTAUTH_HOME' of each Cape Code model to $ROOT.

4. Make sure Auth101 is running.

5. Run SecureCommServer.xml first then also run SecureCommClient.xml.

